---
permalink: /wish_analyzer.html
layout: null
title: "原神抽卡分析"
---
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原神抽卡分析</title>
    <style>
        body {
            background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
            min-height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background: rgba(255,255,255,0.95);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 2em 1.5em;
            margin-top: 2em;
            max-width: 420px;
            width: 100%;
        }
        h1 {
            text-align: center;
            color: #6a4bc6;
        }
        textarea, input[type=text] {
            width: 100%;
            padding: 0.7em;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 1em;
            font-size: 1em;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 0.8em;
            background: #6a4bc6;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin-bottom: 1em;
            transition: background 0.2s;
        }
        button:hover {
            background: #4b2fa6;
        }
        .result {
            margin-top: 1.5em;
            background: #f7f7fb;
            border-radius: 10px;
            padding: 1em;
            font-size: 1em;
            color: #333;
            word-break: break-all;
        }
        @media (max-width: 600px) {
            .container {
                margin-top: 0.5em;
                padding: 1em 0.5em;
            }
            h1 {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>原神抽卡链接分析</h1>
        <textarea id="wishLink" rows="3" placeholder="请粘贴官方抽卡API链接"></textarea>
        <button onclick="analyzeWish()">分析抽卡</button>
        <input type="file" id="jsonFile" accept=".json" style="margin-top:0.5em;width:100%;" />
        <button onclick="analyzeJsonFile()" style="margin-bottom:1em;">分析json文件</button>
        <button onclick="loadDefaultJson()" style="margin-bottom:1em;">加载默认json</button>
        <div class="result" id="result"></div>
        <div id="charts" style="margin-top:1.5em;"></div>
    </div>
    <script src="/assets/js/echarts.min.js"></script>
    <script>
    // 支持 wish_ 链接和官方API链接，API自动翻页，ECharts图表展示
    async function analyzeWish() {
        const input = document.getElementById('wishLink').value.trim();
        const resultDiv = document.getElementById('result');
        document.getElementById('charts').innerHTML = '';
        if (input.startsWith('wish_')) {
            try {
                let base64 = input.slice(5)
                    .replace(/-/g, '+')
                    .replace(/_/g, '/')
                    .replace(/\s/g, '');
                while (base64.length % 4 !== 0) base64 += '=';
                let decoded = atob(base64);
                let data;
                try {
                    data = JSON.parse(decoded);
                } catch {
                    data = decoded;
                }
                if (typeof data === 'string') {
                    const lines = data.split(/\r?\n/).filter(Boolean);
                    let total = 0, five = 0, four = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
                    let fiveList = [], fourList = [];
                    lines.forEach((line, idx) => {
                        total++;
                        if (/五星|5星|★5|\[5]/.test(line)) {
                            five++;
                            fiveList.push({idx: total, line});
                            maxPity = Math.max(maxPity, curPity+1);
                            sumPity += curPity+1;
                            curPity = 0;
                            lastFive = total;
                        } else if (/四星|4星|★4|\[4]/.test(line)) {
                            four++;
                            fourList.push({idx: total, line});
                            curPity++;
                        } else {
                            curPity++;
                        }
                    });
                    let avgPity = five ? (sumPity / five).toFixed(2) : '-';
                    let lastPity = total - lastFive;
                    resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.line}`).join('<br>')}`;
                } else if (typeof data === 'object' && Array.isArray(data.list)) {
                    const list = data.list;
                    let total = list.length, five = 0, four = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
                    let fiveList = [], fourList = [];
                    list.forEach((item, idx) => {
                        total++;
                        if (item.rank_type == '5') {
                            five++;
                            fiveList.push({idx: total, name: item.name, time: item.time});
                            maxPity = Math.max(maxPity, curPity+1);
                            sumPity += curPity+1;
                            curPity = 0;
                            lastFive = total;
                        } else if (item.rank_type == '4') {
                            four++;
                            fourList.push({idx: total, name: item.name, time: item.time});
                            curPity++;
                        } else {
                            curPity++;
                        }
                    });
                    let avgPity = five ? (sumPity / five).toFixed(2) : '-';
                    let lastPity = total - lastFive;
                    resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.name}（${f.time}）`).join('<br>')}`;
                } else {
                    resultDiv.innerHTML = '无法识别的抽卡数据格式。';
                }
            } catch (e) {
                resultDiv.innerHTML = '解析失败：' + e.message;
            }
        } else if (/gachaLog/.test(input)) {
            resultDiv.innerHTML = '正在获取数据...';
            try {
                // 自动翻页抓取所有数据
                let allList = [];
                let page = 1;
                let end_id = '0';
                let size = 20;
                let urlBase = input.replace(/([&?])page=\d+/, '$1page={page}')
                                   .replace(/([&?])size=\d+/, '$1size={size}')
                                   .replace(/([&?])end_id=[^&]*/, '$1end_id={end_id}');
                if (!/page=\{page\}/.test(urlBase)) urlBase += (urlBase.includes('?') ? '&' : '?') + 'page={page}';
                if (!/size=\{size\}/.test(urlBase)) urlBase += '&size={size}';
                if (!/end_id=\{end_id\}/.test(urlBase)) urlBase += '&end_id={end_id}';
                while (true) {
                    let url = urlBase.replace('{page}', page).replace('{size}', size).replace('{end_id}', end_id);
                    let resp = await fetch(url);
                    let data = await resp.json();
                    if (!data.data || !Array.isArray(data.data.list) || data.data.list.length === 0) break;
                    allList = allList.concat(data.data.list);
                    if (data.data.list.length < size) break;
                    end_id = data.data.list[data.data.list.length-1].id;
                    page++;
                    if (page > 100) break; // 防止死循环
                }
                if (allList.length === 0) {
                    resultDiv.innerHTML = '未获取到有效抽卡数据。';
                    return;
                }
                // 统计分析
                const list = allList;
                let total = list.length, five = 0, four = 0, three = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
                let fiveList = [], starMap = {5:0,4:0,3:0}, fivePityArr = [];
                list.forEach((item, idx) => {
                    if (item.rank_type == '5') {
                        five++;
                        fiveList.push({idx: idx+1, name: item.name, time: item.time});
                        maxPity = Math.max(maxPity, curPity+1);
                        sumPity += curPity+1;
                        fivePityArr.push(curPity+1);
                        curPity = 0;
                        lastFive = idx+1;
                        starMap[5]++;
                    } else if (item.rank_type == '4') {
                        four++;
                        curPity++;
                        starMap[4]++;
                    } else {
                        three++;
                        curPity++;
                        starMap[3]++;
                    }
                });
                let avgPity = five ? (sumPity / five).toFixed(2) : '-';
                let lastPity = total - lastFive;
                resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>三星数：<b>${three}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.name}（${f.time}）`).join('<br>')}`;
                // 图表展示
                showWishCharts(starMap, fivePityArr, fiveList);
            } catch (e) {
                resultDiv.innerHTML = '获取或解析失败：' + e.message;
            }
        } else {
            resultDiv.innerHTML = '请输入官方抽卡API链接（含gachaLog）！';
        }
    }

    // ECharts图表展示
    function showWishCharts(starMap, fivePityArr, fiveList) {
        const chartsDiv = document.getElementById('charts');
        chartsDiv.innerHTML = '<div id="starPie" style="width:100%;max-width:350px;height:260px;margin:auto;"></div><div id="pityBar" style="width:100%;max-width:350px;height:260px;margin:auto;"></div>';
        // 星级分布饼图
        let pie = echarts.init(document.getElementById('starPie'));
        pie.setOption({
            title: {text:'星级分布',left:'center',top:10,textStyle:{fontSize:16}},
            tooltip: {trigger:'item'},
            legend: {bottom:0},
            series: [{
                type:'pie',radius:['40%','70%'],
                data:[
                    {value:starMap[5]||0, name:'五星'},
                    {value:starMap[4]||0, name:'四星'},
                    {value:starMap[3]||0, name:'三星'}
                ],
                label:{formatter:'{b}: {c} ({d}%)'}
            }]
        });
        // 五星出货垫刀分布柱状图
        let bar = echarts.init(document.getElementById('pityBar'));
        let pityBins = Array(10).fill(0); // 0-9,10-19,...,90+
        fivePityArr.forEach(n=>{
            let bin = Math.min(Math.floor((n-1)/10),9);
            pityBins[bin]++;
        });
        bar.setOption({
            title:{text:'五星出货垫刀分布',left:'center',top:10,textStyle:{fontSize:16}},
            tooltip:{},
            xAxis:{type:'category',data:['1-10','11-20','21-30','31-40','41-50','51-60','61-70','71-80','81-90','90+']},
            yAxis:{type:'value'},
            series:[{
                type:'bar',data:pityBins,barWidth:'60%',itemStyle:{color:'#eacb5a'}
            }]
        });
    }

    // 新增：分析json文件
    function analyzeJsonFile() {
        const fileInput = document.getElementById('jsonFile');
        const resultDiv = document.getElementById('result');
        document.getElementById('charts').innerHTML = '';
        if (!fileInput.files.length) {
            resultDiv.innerHTML = '请先选择json文件！';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                // 兼容米游社/喵喵等格式
                let list = data.list || (data.data && data.data.list) || data;
                if (!Array.isArray(list)) {
                    resultDiv.innerHTML = '未识别到有效抽卡数据。';
                    return;
                }
                // 统计分析
                let total = list.length, five = 0, four = 0, three = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
                let fiveList = [], starMap = {5:0,4:0,3:0}, fivePityArr = [];
                list.forEach((item, idx) => {
                    if (item.rank_type == '5') {
                        five++;
                        fiveList.push({idx: idx+1, name: item.name, time: item.time});
                        maxPity = Math.max(maxPity, curPity+1);
                        sumPity += curPity+1;
                        fivePityArr.push(curPity+1);
                        curPity = 0;
                        lastFive = idx+1;
                        starMap[5]++;
                    } else if (item.rank_type == '4') {
                        four++;
                        curPity++;
                        starMap[4]++;
                    } else {
                        three++;
                        curPity++;
                        starMap[3]++;
                    }
                });
                let avgPity = five ? (sumPity / five).toFixed(2) : '-';
                let lastPity = total - lastFive;
                resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>三星数：<b>${three}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.name}（${f.time}）`).join('<br>')}`;
                showWishCharts(starMap, fivePityArr, fiveList);
            } catch (err) {
                resultDiv.innerHTML = '解析json失败：' + err.message;
            }
        };
        reader.readAsText(fileInput.files[0]);
    }

    // 新增：加载默认json文件
    function loadDefaultJson() {
        const resultDiv = document.getElementById('result');
        document.getElementById('charts').innerHTML = '';
        fetch('/assets/data/115417212原神抽卡记录.json')
            .then(res => res.json())
            .then(data => {
                let list = data.list || (data.data && data.data.list) || data;
                if (!Array.isArray(list)) {
                    resultDiv.innerHTML = '未识别到有效抽卡数据。';
                    return;
                }
                let total = list.length, five = 0, four = 0, three = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
                let fiveList = [], starMap = {5:0,4:0,3:0}, fivePityArr = [];
                list.forEach((item, idx) => {
                    if (item.rank_type == '5') {
                        five++;
                        fiveList.push({idx: idx+1, name: item.name, time: item.time});
                        maxPity = Math.max(maxPity, curPity+1);
                        sumPity += curPity+1;
                        fivePityArr.push(curPity+1);
                        curPity = 0;
                        lastFive = idx+1;
                        starMap[5]++;
                    } else if (item.rank_type == '4') {
                        four++;
                        curPity++;
                        starMap[4]++;
                    } else {
                        three++;
                        curPity++;
                        starMap[3]++;
                    }
                });
                let avgPity = five ? (sumPity / five).toFixed(2) : '-';
                let lastPity = total - lastFive;
                resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>三星数：<b>${three}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.name}（${f.time}）`).join('<br>')}`;
                showWishCharts(starMap, fivePityArr, fiveList);
            })
            .catch(err => {
                resultDiv.innerHTML = '加载默认json失败：' + err.message;
            });
    }
    </script>
</body>
</html> 