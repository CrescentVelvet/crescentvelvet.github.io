---
permalink: /wish_analyzer.html
layout: null
title: "原神抽卡分析"
---
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原神抽卡分析</title>
    <style>
        body {
            background: linear-gradient(120deg, #3a5fa8 0%, #6a8edb 100%);
            min-height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .main-card {
            background: rgba(255,255,255,0.98);
            border-radius: 18px;
            box-shadow: 0 6px 32px rgba(60,60,120,0.13);
            padding: 2.2em 1.7em 2em 1.7em;
            margin-top: 2.5em;
            max-width: 480px;
            width: 100%;
            position: relative;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 1em;
            margin-bottom: 1.2em;
        }
        .user-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #e0e7ff;
            border: 2px solid #6a8edb;
            object-fit: cover;
        }
        .uid {
            font-size: 1.1em;
            color: #3a5fa8;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .cloud-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: #6a8edb;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.2em;
        }
        .analyze-title {
            text-align: center;
            color: #3a5fa8;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 0.5em;
        }
        .analyze-result {
            text-align: center;
            font-size: 2.1em;
            font-weight: bold;
            color: #e6b800;
            margin-bottom: 0.2em;
            letter-spacing: 2px;
        }
        .analyze-prob {
            text-align: center;
            color: #3a5fa8;
            font-size: 1.1em;
            margin-bottom: 1.2em;
        }
        .stat-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2em 1.5em;
            justify-content: center;
            margin-bottom: 1.2em;
        }
        .stat-item {
            background: #f7faff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(60,60,120,0.06);
            padding: 0.7em 1.2em;
            min-width: 110px;
            text-align: center;
        }
        .stat-label {
            color: #6a8edb;
            font-size: 0.98em;
        }
        .stat-value {
            font-size: 1.25em;
            font-weight: bold;
            color: #3a5fa8;
        }
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            margin-bottom: 1.2em;
        }
        .tag {
            background: #ffe066;
            color: #b38600;
            border-radius: 16px;
            padding: 0.2em 1em;
            font-size: 0.98em;
            font-weight: 500;
            box-shadow: 0 1px 4px rgba(200,180,60,0.08);
        }
        .input-area {
            margin-bottom: 1.2em;
        }
        textarea, input[type=text] {
            width: 100%;
            padding: 0.7em;
            border-radius: 8px;
            border: 1px solid #bfcfff;
            margin-bottom: 1em;
            font-size: 1em;
            box-sizing: border-box;
            background: #f7faff;
        }
        button {
            width: 100%;
            padding: 0.8em;
            background: #3a5fa8;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin-bottom: 1em;
            transition: background 0.2s;
        }
        button:hover {
            background: #2a4a7b;
        }
        .result {
            margin-top: 1.5em;
            background: #f7f7fb;
            border-radius: 10px;
            padding: 1em;
            font-size: 1em;
            color: #333;
            word-break: break-all;
            box-shadow: 0 2px 8px rgba(60,60,120,0.06);
        }
        .tab-group {
            display: flex;
            gap: 0.5em;
            margin-bottom: 1em;
        }
        .tab-btn {
            flex: 1;
            background: #f7faff;
            color: #3a5fa8;
            border: 1px solid #bfcfff;
            border-radius: 8px 8px 0 0;
            font-size: 1em;
            font-weight: bold;
            padding: 0.6em 0;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .tab-btn.active, .tab-btn:focus {
            background: #3a5fa8;
            color: #fff;
            border-bottom: 2px solid #ffe066;
        }
        @media (max-width: 600px) {
            .main-card {
                margin-top: 0.5em;
                padding: 1em 0.5em;
            }
            .analyze-title {
                font-size: 1.1em;
            }
            .analyze-result {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="main-card">
        <div class="user-info">
            <img class="user-avatar" src="/images/site-logo.png" alt="avatar">
            <span class="uid">UID: 11541****2</span>
            <button class="cloud-btn" title="同步云端"><span>☁️</span>同步云端</button>
        </div>
        <div class="analyze-title">经分析，你的抽卡欧皇度为：</div>
        <div class="analyze-result" id="analyzeResult">老非酋</div>
        <div class="analyze-prob" id="analyzeProb">小保底不歪概率：33.3%</div>
        <div class="stat-group">
            <div class="stat-item"><div class="stat-label">总计抽数</div><div class="stat-value" id="statTotal">5167抽</div></div>
            <div class="stat-item"><div class="stat-label">总计消耗</div><div class="stat-value" id="statCost">826720原石</div></div>
            <div class="stat-item"><div class="stat-label">最幸运卡池</div><div class="stat-value" id="statLuck">八重神子卡池</div></div>
        </div>
        <div class="tag-list" id="tagList">
            <span class="tag">4连歪</span>
            <span class="tag">十连双黄</span>
            <span class="tag">3命七七</span>
            <span class="tag">6命琴</span>
            <span class="tag">1命迪希雅</span>
            <span class="tag">4命迪卢克</span>
            <span class="tag">1命提纳里</span>
            <span class="tag">6命刻晴</span>
            <span class="tag">5命莫娜</span>
            <span class="tag">1命那维莱特</span>
            <span class="tag">1命八重神子</span>
            <span class="tag">小保底常歪</span>
            <span class="tag">抽卡坟场</span>
        </div>
        <div class="input-area">
            <div style="display:flex;gap:0.5em;align-items:center;margin-bottom:0.7em;">
                <select id="serverJsonSelect" style="flex:2;padding:0.5em 0.7em;border-radius:8px;border:1px solid #bfcfff;font-size:1em;">
                    <option value="">选择服务器json文件</option>
                    {% for file in site.static_files %}
                        {% if file.path contains '/assets/data/' and file.extname == '.json' %}
                            <option value="{{ file.path }}">{{ file.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <button style="flex:1;min-width:90px;" onclick="analyzeServerJson()">分析服务器json</button>
            </div>
            <textarea id="wishLink" rows="3" placeholder="请粘贴官方抽卡API链接"></textarea>
            <button onclick="analyzeWish()">分析抽卡</button>
        </div>
        <div class="tab-group" style="display:flex;gap:0.5em;margin-bottom:1em;">
            <button class="tab-btn" onclick="switchPoolTab('character')" id="tab-character">角色池</button>
            <button class="tab-btn" onclick="switchPoolTab('weapon')" id="tab-weapon">武器池</button>
            <button class="tab-btn" onclick="switchPoolTab('permanent')" id="tab-permanent">常驻池</button>
            <button class="tab-btn" onclick="switchPoolTab('mixed')" id="tab-mixed">混池</button>
        </div>
        <div class="result" id="result"></div>
        <div id="charts" style="margin-top:1.5em;"></div>
    </div>
    <script src="/assets/js/echarts.min.js"></script>
    <script>
    // 支持 wish_ 链接和官方API链接，API自动翻页，ECharts图表展示
    async function analyzeWish() {
        const input = document.getElementById('wishLink').value.trim();
        const resultDiv = document.getElementById('result');
        document.getElementById('charts').innerHTML = '';
        if (input.startsWith('wish_')) {
            try {
                let base64 = input.slice(5)
                    .replace(/-/g, '+')
                    .replace(/_/g, '/')
                    .replace(/\s/g, '');
                while (base64.length % 4 !== 0) base64 += '=';
                let decoded = atob(base64);
                let data;
                try {
                    data = JSON.parse(decoded);
                } catch {
                    data = decoded;
                }
                if (typeof data === 'string') {
                    const lines = data.split(/\r?\n/).filter(Boolean);
                    let total = 0, five = 0, four = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
                    let fiveList = [], fourList = [];
                    lines.forEach((line, idx) => {
                        total++;
                        if (/五星|5星|★5|\[5]/.test(line)) {
                            five++;
                            fiveList.push({idx: total, line});
                            maxPity = Math.max(maxPity, curPity+1);
                            sumPity += curPity+1;
                            curPity = 0;
                            lastFive = total;
                        } else if (/四星|4星|★4|\[4]/.test(line)) {
                            four++;
                            fourList.push({idx: total, line});
                            curPity++;
                        } else {
                            curPity++;
                        }
                    });
                    let avgPity = five ? (sumPity / five).toFixed(2) : '-';
                    let lastPity = total - lastFive;
                    resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.line}`).join('<br>')}`;
                } else if (typeof data === 'object' && Array.isArray(data.list)) {
                    const list = data.list;
                    let total = list.length, five = 0, four = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
                    let fiveList = [], fourList = [];
                    list.forEach((item, idx) => {
                        total++;
                        if (item.rank_type == '5') {
                            five++;
                            fiveList.push({idx: total, name: item.name, time: item.time});
                            maxPity = Math.max(maxPity, curPity+1);
                            sumPity += curPity+1;
                            curPity = 0;
                            lastFive = total;
                        } else if (item.rank_type == '4') {
                            four++;
                            fourList.push({idx: total, name: item.name, time: item.time});
                            curPity++;
                        } else {
                            curPity++;
                        }
                    });
                    let avgPity = five ? (sumPity / five).toFixed(2) : '-';
                    let lastPity = total - lastFive;
                    resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.name}（${f.time}）`).join('<br>')}`;
                } else {
                    resultDiv.innerHTML = '无法识别的抽卡数据格式。';
                }
            } catch (e) {
                resultDiv.innerHTML = '解析失败：' + e.message;
            }
        } else if (/gachaLog/.test(input)) {
            resultDiv.innerHTML = '正在获取数据...';
            try {
                // 自动翻页抓取所有数据
                let allList = [];
                let page = 1;
                let end_id = '0';
                let size = 20;
                let urlBase = input.replace(/([&?])page=\d+/, '$1page={page}')
                                   .replace(/([&?])size=\d+/, '$1size={size}')
                                   .replace(/([&?])end_id=[^&]*/, '$1end_id={end_id}');
                if (!/page=\{page\}/.test(urlBase)) urlBase += (urlBase.includes('?') ? '&' : '?') + 'page={page}';
                if (!/size=\{size\}/.test(urlBase)) urlBase += '&size={size}';
                if (!/end_id=\{end_id\}/.test(urlBase)) urlBase += '&end_id={end_id}';
                while (true) {
                    let url = urlBase.replace('{page}', page).replace('{size}', size).replace('{end_id}', end_id);
                    let resp = await fetch(url);
                    let data = await resp.json();
                    if (!data.data || !Array.isArray(data.data.list) || data.data.list.length === 0) break;
                    allList = allList.concat(data.data.list);
                    if (data.data.list.length < size) break;
                    end_id = data.data.list[data.data.list.length-1].id;
                    page++;
                    if (page > 100) break; // 防止死循环
                }
                if (allList.length === 0) {
                    resultDiv.innerHTML = '未获取到有效抽卡数据。';
                    return;
                }
                // 统计分析
                const list = allList;
                let total = list.length, five = 0, four = 0, three = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
                let fiveList = [], starMap = {5:0,4:0,3:0}, fivePityArr = [];
                list.forEach((item, idx) => {
                    if (item.rank_type == '5') {
                        five++;
                        fiveList.push({idx: idx+1, name: item.name, time: item.time});
                        maxPity = Math.max(maxPity, curPity+1);
                        sumPity += curPity+1;
                        fivePityArr.push(curPity+1);
                        curPity = 0;
                        lastFive = idx+1;
                        starMap[5]++;
                    } else if (item.rank_type == '4') {
                        four++;
                        curPity++;
                        starMap[4]++;
                    } else {
                        three++;
                        curPity++;
                        starMap[3]++;
                    }
                });
                let avgPity = five ? (sumPity / five).toFixed(2) : '-';
                let lastPity = total - lastFive;
                resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>三星数：<b>${three}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.name}（${f.time}）`).join('<br>')}`;
                // 图表展示
                showWishCharts(starMap, fivePityArr, fiveList);
            } catch (e) {
                resultDiv.innerHTML = '获取或解析失败：' + e.message;
            }
        } else {
            resultDiv.innerHTML = '请输入官方抽卡API链接（含gachaLog）！';
        }
    }

    // ECharts图表展示
    function showWishCharts(starMap, fivePityArr, fiveList) {
        const chartsDiv = document.getElementById('charts');
        chartsDiv.innerHTML = '<div id="starPie" style="width:100%;max-width:350px;height:260px;margin:auto;"></div><div id="pityBar" style="width:100%;max-width:350px;height:260px;margin:auto;"></div>';
        // 星级分布饼图
        let pie = echarts.init(document.getElementById('starPie'));
        pie.setOption({
            title: {text:'星级分布',left:'center',top:10,textStyle:{fontSize:16}},
            tooltip: {trigger:'item'},
            legend: {bottom:0},
            series: [{
                type:'pie',radius:['40%','70%'],
                data:[
                    {value:starMap[5]||0, name:'五星'},
                    {value:starMap[4]||0, name:'四星'},
                    {value:starMap[3]||0, name:'三星'}
                ],
                label:{formatter:'{b}: {c} ({d}%)'}
            }]
        });
        // 五星出货垫刀分布柱状图
        let bar = echarts.init(document.getElementById('pityBar'));
        let pityBins = Array(10).fill(0); // 0-9,10-19,...,90+
        fivePityArr.forEach(n=>{
            let bin = Math.min(Math.floor((n-1)/10),9);
            pityBins[bin]++;
        });
        bar.setOption({
            title:{text:'五星出货垫刀分布',left:'center',top:10,textStyle:{fontSize:16}},
            tooltip:{},
            xAxis:{type:'category',data:['1-10','11-20','21-30','31-40','41-50','51-60','61-70','71-80','81-90','90+']},
            yAxis:{type:'value'},
            series:[{
                type:'bar',data:pityBins,barWidth:'60%',itemStyle:{color:'#eacb5a'}
            }]
        });
    }

    // 池子类型映射
    const POOL_MAP = {
        '301': 'character', // 角色池
        '400': 'character', // 新角色池
        '302': 'weapon',    // 武器池
        '200': 'permanent', // 常驻池
        '100': 'mixed'      // 混池
    };
    let poolData = {
        character: [],
        weapon: [],
        permanent: [],
        mixed: []
    };
    let currentPool = 'character';

    function switchPoolTab(pool) {
        currentPool = pool;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('tab-' + pool).classList.add('active');
        showPoolResult(pool);
    }

    function showPoolResult(pool) {
        const resultDiv = document.getElementById('result');
        const chartsDiv = document.getElementById('charts');
        const list = poolData[pool] || [];
        if (!list.length) {
            resultDiv.innerHTML = '该池暂无数据';
            chartsDiv.innerHTML = '';
            return;
        }
        // 统计分析（与原有分析逻辑一致）
        let total = list.length, five = 0, four = 0, three = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
        let fiveList = [], starMap = {5:0,4:0,3:0}, fivePityArr = [];
        list.forEach((item, idx) => {
            if (item.rank_type == '5') {
                five++;
                fiveList.push({idx: idx+1, name: item.name, time: item.time});
                maxPity = Math.max(maxPity, curPity+1);
                sumPity += curPity+1;
                fivePityArr.push(curPity+1);
                curPity = 0;
                lastFive = idx+1;
                starMap[5]++;
            } else if (item.rank_type == '4') {
                four++;
                curPity++;
                starMap[4]++;
            } else {
                three++;
                curPity++;
                starMap[3]++;
            }
        });
        let avgPity = five ? (sumPity / five).toFixed(2) : '-';
        let lastPity = total - lastFive;
        resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>三星数：<b>${three}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.name}（${f.time}）`).join('<br>')}`;
        showWishCharts(starMap, fivePityArr, fiveList);
    }

    // 修改分析json和API等函数，将数据分池归类
    function classifyPool(list) {
        poolData = {character:[], weapon:[], permanent:[], mixed:[]};
        list.forEach(item => {
            const pool = POOL_MAP[item.gacha_type || item.uigf_gacha_type] || 'character';
            poolData[pool].push(item);
        });
    }

    // 新增：分析服务器json文件
    function analyzeServerJson() {
        const select = document.getElementById('serverJsonSelect');
        const path = select.value;
        const resultDiv = document.getElementById('result');
        document.getElementById('charts').innerHTML = '';
        if (!path) {
            resultDiv.innerHTML = '请选择服务器上的json文件！';
            return;
        }
        fetch(path)
            .then(res => res.json())
            .then(data => {
                let list = data.list || (data.data && data.data.list) || data;
                if (!Array.isArray(list)) {
                    resultDiv.innerHTML = '未识别到有效抽卡数据。';
                    return;
                }
                let total = list.length, five = 0, four = 0, three = 0, maxPity = 0, curPity = 0, sumPity = 0, lastFive = 0;
                let fiveList = [], starMap = {5:0,4:0,3:0}, fivePityArr = [];
                list.forEach((item, idx) => {
                    if (item.rank_type == '5') {
                        five++;
                        fiveList.push({idx: idx+1, name: item.name, time: item.time});
                        maxPity = Math.max(maxPity, curPity+1);
                        sumPity += curPity+1;
                        fivePityArr.push(curPity+1);
                        curPity = 0;
                        lastFive = idx+1;
                        starMap[5]++;
                    } else if (item.rank_type == '4') {
                        four++;
                        curPity++;
                        starMap[4]++;
                    } else {
                        three++;
                        curPity++;
                        starMap[3]++;
                    }
                });
                let avgPity = five ? (sumPity / five).toFixed(2) : '-';
                let lastPity = total - lastFive;
                resultDiv.innerHTML = `总抽数：<b>${total}</b><br>五星数：<b>${five}</b><br>四星数：<b>${four}</b><br>三星数：<b>${three}</b><br>最大垫刀：<b>${maxPity}</b><br>平均垫刀：<b>${avgPity}</b><br>距离上次出金：<b>${lastPity}</b><br><hr>五星出货：<br>${fiveList.map(f=>`第${f.idx}抽：${f.name}（${f.time}）`).join('<br>')}`;
                classifyPool(list);
                switchPoolTab(currentPool);
            })
            .catch(err => {
                resultDiv.innerHTML = '加载服务器json失败：' + err.message;
            });
    }
    </script>
</body>
</html> 