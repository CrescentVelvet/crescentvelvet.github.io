---
permalink: /travel_map.html
layout: null
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的航旅足迹</title>
    <!-- 引入 Leaflet 样式 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- 引入 Leaflet 脚本 -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- 引入 Leaflet.curve 插件，用于绘制曲线 -->
    <script src="https://unpkg.com/leaflet-curve@2.0.0/leaflet.curve.js"></script>
    <style>
        html, body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #1E90FF;
            color: white;
            padding: 15px;
            text-align: center;
            height: 30px;
            line-height: 30px;
            z-index: 2;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .content {
            display: flex;
            flex: 1;
            height: calc(100% - 60px); /* 减去header的高度 */
            overflow: hidden;
            position: relative;
        }
        
        /* 加载指示器样式 */
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1E90FF;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sidebar {
            width: 300px;
            background-color: #f4f4f4;
            padding: 20px;
            overflow-y: auto;
            z-index: 2;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            height: 100%;
            transition: max-height 0.3s;
        }

        #map {
            flex: 1;
            height: 100% !important; /* 确保地图容器有高度 */
            width: 100% !important;
            position: relative !important;
            z-index: 1;
        }

        .form-container {
            margin-bottom: 20px;
        }

        input, button {
            margin: 5px;
            padding: 8px;
            width: calc(100% - 10px);
        }

        button {
            background-color: #1E90FF;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #187bcd;
        }

        .location-item {
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .autocomplete-suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background-color: white;
            z-index: 1000;
            width: calc(100% - 10px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        /* 响应式：移动端下侧栏折叠，地图最大化 */
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                box-shadow: none;
                padding: 10px;
                position: relative;
                z-index: 10;
                max-height: 60vh;
                overflow-y: auto;
                transition: max-height 0.3s;
            }
            #map {
                width: 100% !important;
                height: calc(100vh - 60px) !important;
                min-height: 300px;
            }
            .sidebar.collapsed {
                max-height: 0;
                padding: 0;
                overflow: hidden;
            }
            .sidebar-toggle-btn {
                display: block;
                width: 100%;
                background: #1E90FF;
                color: #fff;
                border: none;
                padding: 10px;
                font-size: 16px;
                cursor: pointer;
                border-radius: 0;
                margin-bottom: 0;
            }
        }
        @media (min-width: 769px) {
            .sidebar-toggle-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>我的航旅足迹</h1>
    </div>
    <div class="content">
        <button class="sidebar-toggle-btn" onclick="toggleSidebar()">☰ 显示/隐藏航线操作区</button>
        <div class="sidebar">
            <div class="form-container">
                <input type="text" id="departure" placeholder="出发机场 (如: PEK, 北京首都)">
                <div id="departure-suggestions" class="autocomplete-suggestions"></div>
                <input type="text" id="arrival" placeholder="到达机场 (如: SHA, 上海虹桥)">
                <div id="arrival-suggestions" class="autocomplete-suggestions"></div>
                <input type="datetime-local" id="flight-time">
                <select id="flight-type" style="margin: 5px; padding: 8px; width: calc(100% - 10px);">
                    <option value="direct">直飞航线</option>
                    <option value="curved">弧线航线</option>
                </select>
                <button onclick="addFlight()">添加航线</button>
                <button onclick="clearFlights()" style="background-color: #008B8B;">清除所有航线</button>
                <button id="toggleAnimationBtn" onclick="toggleAnimation()" style="background-color: #FF6347;">播放航线动画</button>
                <button onclick="exportFlightPaths()" style="background-color: #77c306;">导出航线</button>
                <button id="backHomeBtn" class="action-button" onclick="window.location.href='index.html'" style="background-color: #FF4500;">返回首页</button>
            </div>
            <div id="flight-list"></div>
        </div>
        <div id="map">
            <!-- 地图加载指示器 -->
            <div id="map-loading" class="map-loading">
                <div class="loading-spinner"></div>
                <div id="loading-text">正在加载地图...</div>
            </div>
        </div>
    </div>

    <script>
        // 添加调试信息 - 检查DOM是否已加载
        console.log('DOM加载状态:', document.readyState);
        
        // 全局变量，用于跟踪地图瓦片加载状态
        var tileLoadErrors = 0;
        var tileLoadSuccess = 0;
        
        // 添加全局错误处理函数，用于捕获地图瓦片加载错误
        function handleTileError(event) {
            tileLoadErrors++;
            
            // 获取当前活动图层名称
            var currentLayerName = '未知';
            if (window.fourthLayerAdded) {
                currentLayerName = '第四备用图层(Mapbox)';
            } else if (window.fallbackLayerAdded) {
                currentLayerName = '第二备用图层(CartoDB)';
            } else if (window.thirdLayerAdded) {
                currentLayerName = '第三备用图层(Stadia Maps)';
            } else {
                currentLayerName = '主图层(高德地图)';
            }
            
            // 详细记录错误信息
            var errorSource = event.target && (event.target.src || event.target.href) ? (event.target.src || event.target.href) : '未知源';
            var errorType = event.type || '未知错误类型';
            var errorMessage = event.message || '无错误消息';
            var errorStatus = event.target && event.target.status ? event.target.status : '未知状态';
            
            console.warn(`地图瓦片加载失败(${currentLayerName}):`, {
                错误源: errorSource,
                错误类型: errorType,
                错误消息: errorMessage,
                错误状态: errorStatus,
                错误计数: tileLoadErrors,
                完整事件: event
            });
            
            // 更新加载指示器消息
            var loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.textContent = `${currentLayerName}加载中...遇到 ${tileLoadErrors} 个错误，正在尝试恢复`;
            }
            
            // 如果错误太多，尝试切换到备用图层
            if (tileLoadErrors > 5 && window.travelMap && window.fallbackLayerAdded === false) {
                console.warn('检测到多个瓦片加载错误，尝试切换到第二备用图层(CartoDB)');
                showMapLoading('主地图服务不可用，正在切换到第二备用地图...');
                try {
                    // 移除主图层，减少错误
                    if (window.mainLayer && window.travelMap) {
                        window.travelMap.removeLayer(window.mainLayer);
                    }
                    
                    window.fallbackLayer.addTo(window.travelMap);
                    window.fallbackLayerAdded = true;
                    console.log('已切换到第二备用地图图层(CartoDB)');
                    // 重置计数器，给新图层一个机会
                    tileLoadErrors = 0;
                    tileLoadSuccess = 0;
                    
                    // 添加第二备用图层的错误监听
                    window.fallbackLayer.on('tileerror', function(event) {
                        handleTileError(event);
                    });
                    
                    window.fallbackLayer.on('tileload', function() {
                        handleTileLoad();
                    });
                } catch (error) {
                    console.error('切换到第二备用图层(CartoDB)失败:', error);
                }
            } else if (tileLoadErrors > 15 && window.travelMap && window.thirdLayerAdded === false) {
                console.warn('检测到过多瓦片加载错误，尝试切换到第三备用图层(Stadia Maps)');
                showMapLoading('第二备用地图服务不可用，正在切换到第三备用地图...');
                try {
                    // 移除之前的图层
                    if (window.fallbackLayerAdded && window.fallbackLayer && window.travelMap) {
                        window.travelMap.removeLayer(window.fallbackLayer);
                    }
                    
                    window.thirdLayer.addTo(window.travelMap);
                    window.thirdLayerAdded = true;
                    console.log('已切换到第三备用地图图层(Stadia Maps)');
                    // 重置计数器
                    tileLoadErrors = 0;
                    tileLoadSuccess = 0;
                    
                    // 添加第三备用图层的错误监听
                    window.thirdLayer.on('tileerror', function(event) {
                        handleTileError(event);
                    });
                    
                    window.thirdLayer.on('tileload', function() {
                        handleTileLoad();
                    });
                } catch (error) {
                    console.error('切换到第三备用图层(Stadia Maps)失败:', error);
                }
            } else if (tileLoadErrors > 25 && window.travelMap && window.fourthLayerAdded === false) {
                console.warn('检测到严重瓦片加载错误，尝试切换到第四备用图层(Mapbox)');
                showMapLoading('第三备用地图服务不可用，正在切换到第四备用地图...');
                try {
                    // 移除之前的图层
                    if (window.thirdLayerAdded && window.thirdLayer && window.travelMap) {
                        window.travelMap.removeLayer(window.thirdLayer);
                    }
                    
                    window.fourthLayer.addTo(window.travelMap);
                    window.fourthLayerAdded = true;
                    console.log('已切换到第四备用地图图层(Mapbox)');
                    // 重置计数器
                    tileLoadErrors = 0;
                    tileLoadSuccess = 0;
                    
                    // 添加第四备用图层的错误监听
                    window.fourthLayer.on('tileerror', function(event) {
                        handleTileError(event);
                    });
                    
                    window.fourthLayer.on('tileload', function() {
                        handleTileLoad();
                    });
                } catch (error) {
                    console.error('切换到第四备用图层(Mapbox)失败:', error);
                }
            } else if (tileLoadErrors > 35) {
                // 所有图层都失败
                showMapLoading('所有地图服务均不可用，请检查网络连接或稍后再试');
            }
        }
        
        // 添加全局函数，用于处理地图瓦片加载成功
        function handleTileLoad() {
            tileLoadSuccess++;
            
            // 获取当前活动图层名称
            var currentLayerName = '未知';
            if (window.fourthLayerAdded) {
                currentLayerName = '第四备用图层(Mapbox)';
            } else if (window.fallbackLayerAdded) {
                currentLayerName = '第二备用图层(CartoDB)';
            } else if (window.thirdLayerAdded) {
                currentLayerName = '第三备用图层(Stadia Maps)';
            } else {
                currentLayerName = '主图层(高德地图)';
            }
            
            // 每50个瓦片记录一次加载进度
            if (tileLoadSuccess % 50 === 0) {
                console.log(`${currentLayerName}已成功加载 ${tileLoadSuccess} 个瓦片`);
            }
            
            // 更新加载进度
            var loadingText = document.getElementById('loading-text');
            if (loadingText) {
                // 如果加载了足够多的瓦片，隐藏加载指示器
                if (tileLoadSuccess > 15) {
                    hideMapLoading();
                    // console.log(`${currentLayerName}加载完成，已加载 ${tileLoadSuccess} 个瓦片`);
                } else {
                    loadingText.textContent = `正在加载${currentLayerName}...已加载 ${tileLoadSuccess} 个瓦片`;
                }
            }
        }
        
        // 显示地图加载指示器
        function showMapLoading(message) {
            var loadingElement = document.getElementById('map-loading');
            var loadingText = document.getElementById('loading-text');
            
            if (loadingElement) {
                loadingElement.style.display = 'flex';
                
                if (loadingText && message) {
                    loadingText.textContent = message;
                }
            }
        }
        
        // 隐藏地图加载指示器
        function hideMapLoading() {
            var loadingElement = document.getElementById('map-loading');
            
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
        
        // 使用window.onload确保所有资源（包括图片）都加载完成
        window.onload = function() {
            console.log('所有资源加载完成，开始初始化地图');
            // 给DOM渲染一些时间
            setTimeout(function() {
                console.log('地图容器元素:', document.getElementById('map'));
                console.log('地图容器尺寸:', document.getElementById('map').offsetWidth, 'x', document.getElementById('map').offsetHeight);
                initMap();
            }, 500);
        };
        
        // 添加全局错误处理
        window.addEventListener('error', function(event) {
            if (event.target && (event.target.src || event.target.href)) {
                var resource = event.target.src || event.target.href;
                // 检查是否是地图瓦片资源
                if (resource.includes('tile') || 
                    resource.includes('mapbox') || 
                    resource.includes('carto') || 
                    resource.includes('stadiamaps') || 
                    resource.includes('autonavi')) {
                    
                    console.log('捕获到地图资源加载错误:', resource);
                    handleTileError(event);
                    
                    // 阻止错误冒泡
                    event.stopPropagation();
                    event.preventDefault();
                    return true;
                }
            }
        }, true); // 使用捕获阶段
        
        // 添加全局图片错误处理
        document.addEventListener('error', function(event) {
            if (event.target && event.target.tagName === 'IMG' && event.target.classList.contains('leaflet-tile')) {
                console.log('捕获到地图瓦片图片加载错误:', event.target.src);
                handleTileError(event);
                return true;
            }
        }, true);
        
        function initMap() {
            try {
                // 初始化地图
                console.log('正在初始化地图...');
                var mapContainer = document.getElementById('map');
                console.log('地图容器尺寸:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
                
                // 确保地图容器可见
                mapContainer.style.display = 'block';
                
                // 显示加载指示器
                showMapLoading('正在初始化地图...');
                
                // 创建地图实例
                var map = L.map('map', {
                    center: [35.0, 105.0], // 中国中心位置
                    zoom: 4,
                    minZoom: 2,
                    maxZoom: 18,
                    zoomControl: true,
                    attributionControl: true
                });

                // 添加地图图层 - 使用更可靠的地图源
                // 创建主图层并存储到全局变量 - 使用高德地图作为主图层
                window.mainLayer = L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                    attribution: '© 高德地图',
                    subdomains: "1234",
                    maxZoom: 19,
                    // 添加错误处理选项
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=', // 透明图片
                    crossOrigin: true
                });
                
                // 创建备用图层并存储到全局变量 - 使用CartoDB作为备用
                window.fallbackLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=',
                    crossOrigin: true
                });
                
                // 第三备用图层 - 使用Stadia Maps作为第三备用
                window.thirdLayer = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                    subdomains: 'abcd',
                    maxZoom: 19,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=',
                    crossOrigin: true
                });
                
                // 第四备用图层 - 使用Mapbox
                window.fourthLayer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY3Jlc2NlbnR2ZWx2ZXQiLCJhIjoiY2xzMWFkZGRsMDFnMzJrbXUyaGdqcXdwdyJ9.Jm9RZGiQE3I1t9KyQqYXYA', {
                    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    id: 'mapbox/streets-v11',
                    tileSize: 512,
                    zoomOffset: -1,
                    maxZoom: 19,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=',
                    crossOrigin: true
                });
                
                // 初始化图层状态标志
                window.fallbackLayerAdded = false;
                window.thirdLayerAdded = false;
                window.fourthLayerAdded = false;
                
                // 添加瓦片加载事件监听
                window.mainLayer.on('tileerror', function(event) {
                    handleTileError(event);
                });
                
                window.mainLayer.on('tileload', function() {
                    handleTileLoad();
                });
                
                // 尝试添加主图层，如果失败则使用备用图层
                try {
                    window.mainLayer.addTo(map);
                    console.log('主地图图层(高德地图)加载成功');
                } catch (error) {
                    console.error('主地图图层加载失败，尝试备用图层:', error);
                    showMapLoading('主地图服务不可用，正在切换到备用地图...');
                    
                    try {
                        window.fallbackLayer.addTo(map);
                        window.fallbackLayerAdded = true;
                        console.log('第二备用地图图层(CartoDB)加载成功');
                        
                        // 添加第二备用图层的错误监听
                        window.fallbackLayer.on('tileerror', function(event) {
                            handleTileError(event);
                        });
                        
                        window.fallbackLayer.on('tileload', function() {
                            handleTileLoad();
                        });
                    } catch (fallbackError) {
                        console.error('第二备用地图图层(CartoDB)加载失败，尝试第三备用图层:', fallbackError);
                        showMapLoading('第二备用地图服务不可用，正在切换到第三备用地图...');
                        
                        try {
                            window.thirdLayer.addTo(map);
                            window.thirdLayerAdded = true;
                            console.log('第三备用地图图层(Stadia Maps)加载成功');
                            
                            // 添加第三备用图层的错误监听
                            window.thirdLayer.on('tileerror', function(event) {
                                handleTileError(event);
                            });
                            
                            window.thirdLayer.on('tileload', function() {
                                handleTileLoad();
                            });
                        } catch (thirdError) {
                            console.error('第三备用地图图层(Stadia Maps)加载失败，尝试第四备用图层:', thirdError);
                            showMapLoading('第三备用地图服务不可用，正在切换到第四备用地图...');
                            
                            try {
                                window.fourthLayer.addTo(map);
                                window.fourthLayerAdded = true;
                                console.log('第四备用地图图层(Mapbox)加载成功');
                                
                                // 添加第四备用图层的错误监听
                                window.fourthLayer.on('tileerror', function(event) {
                                    handleTileError(event);
                                });
                                
                                window.fourthLayer.on('tileload', function() {
                                    handleTileLoad();
                                });
                            } catch (fourthError) {
                                console.error('所有地图图层加载失败:', fourthError);
                                showMapLoading('所有地图服务均不可用，请检查网络连接或稍后再试');
                                
                                setTimeout(function() {
                                    alert('地图图层加载失败，请检查网络连接');
                                }, 500);
                            }
                        }
                    }
                }

                console.log('地图初始化完成');
                
                // 存储地图实例到全局变量
                window.travelMap = map;
                
                // 地图初始化完成事件
                map.whenReady(function() {
                    console.log('地图初始化完成，等待瓦片加载...');
                    
                    // 强制重新计算地图大小
                    map.invalidateSize();
                    console.log('地图大小已重新计算');
                    
                    // 如果没有瓦片错误，隐藏加载指示器
                    setTimeout(function() {
                        if (tileLoadErrors === 0 || tileLoadSuccess > 10) {
                            hideMapLoading();
                            console.log('地图加载完成，隐藏加载指示器');
                        } else {
                            console.log('检测到瓦片加载错误，保持加载指示器显示');
                        }
                        
                        // 从JSON文件加载初始航线数据
                        fetch('assets/data/initial_flight_paths.json')
                            .then(response => response.json())
                            .then(data => {
                                flightInfo = data || [];
                                console.log('初始航线数据加载成功:', flightInfo);
                                // 确保在数据加载完成后初始化航线
                                initFlightPaths();
                            })
                            .catch(error => {
                                console.error('加载初始航线数据失败:', error);
                                // 如果加载失败，仍然尝试初始化航线，但数据为空
                                initFlightPaths();
                            });

                    }, 1000); // 增加延迟，确保瓦片有足够时间加载
                });
            } catch (error) {
                console.error('地图初始化失败:', error);
                // 更新加载指示器显示错误信息
                showMapLoading('地图加载失败，请刷新页面重试');
                // 延迟显示错误提示，避免加载指示器被立即隐藏
                setTimeout(function() {
                    alert('地图加载失败，请查看控制台获取详细信息');
                }, 500);
            }
        }

        // 存储航线和航班信息
        var flightInfo = [];
        var flightPaths = [];
        var animationMarker;
        var animationPath;
        var animationInterval;
        
        // 常用机场数据 - 包含IATA代码、名称、经纬度
        var airports = {
            // 中国主要机场
            "PEK": { name: "北京首都国际机场", lat: 40.0799, lng: 116.6031 },
            "PKX": { name: "北京大兴国际机场", lat: 39.5098, lng: 116.4105 },
            "SHA": { name: "上海虹桥国际机场", lat: 31.1979, lng: 121.3363 },
            "PVG": { name: "上海浦东国际机场", lat: 31.1443, lng: 121.8083 },
            "CAN": { name: "广州白云国际机场", lat: 23.3959, lng: 113.3080 },
            "SZX": { name: "深圳宝安国际机场", lat: 22.6394, lng: 113.8106 },
            "CTU": { name: "成都双流国际机场", lat: 30.5785, lng: 103.9471 },
            "TFU": { name: "成都天府国际机场", lat: 30.3125, lng: 104.4415 },
            "CKG": { name: "重庆江北国际机场", lat: 29.7192, lng: 106.6413 },
            "XIY": { name: "西安咸阳国际机场", lat: 34.4471, lng: 108.7516 },
            "HGH": { name: "杭州萧山国际机场", lat: 30.2294, lng: 120.4412 },
            "NKG": { name: "南京禄口国际机场", lat: 31.7418, lng: 118.8673 },
            "CSX": { name: "长沙黄花国际机场", lat: 28.1913, lng: 113.2192 },
            "KMG": { name: "昆明长水国际机场", lat: 25.1019, lng: 102.9299 },
            "WUH": { name: "武汉天河国际机场", lat: 30.7838, lng: 114.2081 },
            "TSN": { name: "天津滨海国际机场", lat: 39.1246, lng: 117.3462 },
            "CGO": { name: "郑州新郑国际机场", lat: 34.5196, lng: 113.8408 },
            "TAO": { name: "青岛流亭国际机场", lat: 36.2661, lng: 120.3826 },
            "DLC": { name: "大连周水子国际机场", lat: 38.9657, lng: 121.5385 },
            "SYX": { name: "三亚凤凰国际机场", lat: 18.3029, lng: 109.4120 },
            "ZJK": { name: "湛江吴川机场", lat: 21.485, lng: 110.168 },
            "ZHA": { name: "湛江霞山机场", lat: 21.2144, lng: 110.358 },
            "YIN": { name: "伊宁机场", lat: 43.953, lng: 81.331 },
            "XMN": { name: "厦门高崎国际机场", lat: 24.544, lng: 118.127 },
            "KHN": { name: "南昌昌北国际机场", lat: 28.867, lng: 115.908 },
            "URC": { name: "乌鲁木齐地窝堡国际机场", lat: 43.907, lng: 87.475 },
            "HGH": { name: "杭州萧山国际机场", lat: 30.2294, lng: 120.4412 },
            "HAK": { name: "海口美兰国际机场", lat: 19.9349, lng: 110.4590 },
            
            // 国际主要机场
            "HKG": { name: "香港国际机场", lat: 22.3080, lng: 113.9185 },
            "TPE": { name: "台北桃园国际机场", lat: 25.0797, lng: 121.2342 },
            "NRT": { name: "东京成田国际机场", lat: 35.7647, lng: 140.3864 },
            "HND": { name: "东京羽田国际机场", lat: 35.5494, lng: 139.7798 },
            "ICN": { name: "首尔仁川国际机场", lat: 37.4602, lng: 126.4407 },
            "SIN": { name: "新加坡樟宜国际机场", lat: 1.3644, lng: 103.9915 },
            "BKK": { name: "曼谷素万那普国际机场", lat: 13.6900, lng: 100.7501 },
            "KUL": { name: "吉隆坡国际机场", lat: 2.7456, lng: 101.7099 },
            "JFK": { name: "纽约肯尼迪国际机场", lat: 40.6413, lng: -73.7781 },
            "LAX": { name: "洛杉矶国际机场", lat: 33.9416, lng: -118.4085 },
            "LHR": { name: "伦敦希思罗国际机场", lat: 51.4700, lng: -0.4543 },
            "CDG": { name: "巴黎戴高乐国际机场", lat: 49.0097, lng: 2.5479 },
            "FRA": { name: "法兰克福国际机场", lat: 50.0379, lng: 8.5622 },
            "SYD": { name: "悉尼金斯福德·史密斯国际机场", lat: -33.9399, lng: 151.1753 },
            "KIX": { name: "大阪关西国际机场", lat: 34.4272, lng: 135.2447 },
            "KUL": { name: "吉隆坡国际机场", lat: 2.7456, lng: 101.7099 },
            "BKI": { name: "哥打京那巴鲁国际机场", lat: 5.9378, lng: 116.0511 }
        };
        
        // 搜索机场函数
        function searchAirport(query) {
            query = query.trim().toUpperCase();
            
            // 直接匹配IATA代码
            if (airports[query]) {
                return [{
                    code: query,
                    ...airports[query]
                }];
            }
            
            // 搜索机场名称
            var results = [];
            for (var code in airports) {
                if (airports[code].name.includes(query) || code.includes(query)) {
                    results.push({
                        code: code,
                        ...airports[code]
                    });
                }
            }
            
            return results;
        }
        
        // 在地图初始化完成后初始化航线
        function initFlightPaths() {
            if (window.travelMap) {
                console.log('初始化航线');
                try {
                    // 清除现有航线
                    clearFlightPaths();
                    
                    // 绘制所有保存的航线
                    flightInfo.forEach((flight, index) => {
                        drawFlight(flight.from, flight.to, flight.type, index);
                    });
                    
                    // 更新航班列表
                    updateFlightList();
                    
                    // 如果有航线，调整地图视图
                    if (flightPaths.length > 0) {
                        fitMapToFlights();
                    }
                    
                    console.log('航线初始化完成');
                } catch (error) {
                    console.error('航线初始化失败:', error);
                }
            } else {
                console.error('地图未初始化，无法添加航线');
                // 稍后重试
                setTimeout(initFlightPaths, 1000);
            }
        }
        
        // 清除所有航线路径
        function clearFlightPaths() {
            flightPaths.forEach(path => {
                if (window.travelMap) {
                    window.travelMap.removeLayer(path.path);
                    if (path.markers) {
                        path.markers.forEach(marker => window.travelMap.removeLayer(marker));
                    }
                }
            });
            flightPaths = [];
        }
        
        // 绘制单个航线
        function drawFlight(from, to, type, index) {
            if (!window.travelMap) return;
            
            try {
                // 创建出发和到达机场的标记
                var departureMarker = L.marker([from.lat, from.lng], {
                    icon: L.divIcon({
                        className: 'airport-marker',
                        html: `<div style="background-color: #1E90FF; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-weight: bold;">${from.code}</div>`,
                        iconSize: [24, 24]
                    })
                }).addTo(window.travelMap).bindPopup(`<b>${from.name}</b><br>${from.code}`);
                
                var arrivalMarker = L.marker([to.lat, to.lng], {
                    icon: L.divIcon({
                        className: 'airport-marker',
                        html: `<div style="background-color: #FF6347; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-weight: bold;">${to.code}</div>`,
                        iconSize: [24, 24]
                    })
                }).addTo(window.travelMap).bindPopup(`<b>${to.name}</b><br>${to.code}`);
                
                var flightPath;
                var flightPathOptions = {
                    color: getFlightColor(index),
                    weight: 3,
                    opacity: 0.8,
                    dashArray: '5, 5'
                };
                
                if (type === 'curved') {
                    // 创建弧线航线
                    var latlngs = calculateCurvedPath(from, to);
                    flightPath = L.polyline(latlngs, flightPathOptions).addTo(window.travelMap);
                } else {
                    // 创建直线航线
                    flightPath = L.polyline([[from.lat, from.lng], [to.lat, to.lng]], flightPathOptions).addTo(window.travelMap);
                }
                
                // 添加飞机图标在航线中间
                var midPoint = getMidPoint(from, to, type === 'curved');
                var planeIcon = L.divIcon({
                    className: 'plane-icon',
                    html: '<div style="font-size: 20px; transform: rotate(45deg);">✈️</div>',
                    iconSize: [20, 20]
                });
                
                var planeMarker = L.marker(midPoint, { icon: planeIcon }).addTo(window.travelMap);
                
                // 存储航线信息
                flightPaths.push({
                    path: flightPath,
                    markers: [departureMarker, arrivalMarker, planeMarker],
                    from: from,
                    to: to,
                    type: type
                });
                
            } catch (error) {
                console.error('绘制航线失败:', error);
            }
        }
        
        // 计算弧线路径点
        function calculateCurvedPath(from, to) {
            var latlngs = [];
            var offsetX = (to.lng - from.lng) * 0.15;
            var offsetY = (to.lat - from.lat) * 0.15;
            var midLat = (from.lat + to.lat) / 2;
            var midLng = (from.lng + to.lng) / 2;
            
            // 计算垂直于连线的方向
            var dx = to.lng - from.lng;
            var dy = to.lat - from.lat;
            var dist = Math.sqrt(dx * dx + dy * dy);
            
            // 弧线高度与距离成正比
            var curveHeight = dist * 0.15;
            
            // 垂直方向的单位向量
            var perpX = -dy / dist;
            var perpY = dx / dist;
            
            // 弧线的控制点
            var ctrlLat = midLat + perpY * curveHeight;
            var ctrlLng = midLng + perpX * curveHeight;
            
            // 生成弧线上的点
            for (var i = 0; i <= 100; i++) {
                var t = i / 100;
                var lat = (1 - t) * (1 - t) * from.lat + 2 * (1 - t) * t * ctrlLat + t * t * to.lat;
                var lng = (1 - t) * (1 - t) * from.lng + 2 * (1 - t) * t * ctrlLng + t * t * to.lng;
                latlngs.push([lat, lng]);
            }
            
            return latlngs;
        }
        
        // 获取航线中点
        function getMidPoint(from, to, curved) {
            if (curved) {
                var dx = to.lng - from.lng;
                var dy = to.lat - from.lat;
                var dist = Math.sqrt(dx * dx + dy * dy);
                
                // 垂直方向的单位向量
                var perpX = -dy / dist;
                var perpY = dx / dist;
                
                // 弧线高度与距离成正比
                var curveHeight = dist * 0.15;
                
                // 弧线的最高点
                var midLat = (from.lat + to.lat) / 2 + perpY * curveHeight;
                var midLng = (from.lng + to.lng) / 2 + perpX * curveHeight;
                
                return [midLat, midLng];
            } else {
                return [(from.lat + to.lat) / 2, (from.lng + to.lng) / 2];
            }
        }
        
        // 根据索引获取不同颜色
        function getFlightColor(index) {
            var colors = ['#1E90FF', '#FF6347', '#32CD32', '#FFD700', '#9370DB', '#FF69B4', '#20B2AA', '#FF8C00', '#4682B4', '#8A2BE2'];
            return colors[index % colors.length];
        }
        
        // 调整地图视图以适应所有航线
        function fitMapToFlights() {
            if (flightPaths.length === 0 || !window.travelMap) return;
            
            var bounds = L.latLngBounds();
            flightPaths.forEach(path => {
                bounds.extend([path.from.lat, path.from.lng]);
                bounds.extend([path.to.lat, path.to.lng]);
            });
            
            window.travelMap.fitBounds(bounds, { padding: [50, 50] });
        }
        
        // 保存原始的window.onload函数
        var originalOnload = window.onload;
        window.onload = function() {
            if (originalOnload) originalOnload();
            // 注意：initFlightPaths会在地图初始化完成后自动调用
            // 不需要在这里再次调用
        };

        // 更新航班列表
        function updateFlightList() {
            var flightList = document.getElementById('flight-list');
            flightList.innerHTML = '';
            flightInfo.forEach((info, index) => {
                var item = document.createElement('div');
                item.className = 'location-item';
                item.innerHTML = `
                    <h4>${info.from.code} → ${info.to.code}</h4>
                    <p>${info.from.name} → ${info.to.name}</p>
                    <p>${info.time || '未设置时间'}</p>
                    <p>航线类型: ${info.type === 'curved' ? '弧线' : '直线'}</p>
                    <button onclick="removeFlight(${index})">删除</button>
                `;
                flightList.appendChild(item);
            });
        }

        // 添加航线
        function addFlight() {
            if (!window.travelMap) {
                alert('地图尚未初始化，请稍后再试');
                console.error('添加航线失败：地图未初始化');
                return;
            }
            
            var departureInput = document.getElementById('departure');
            var arrivalInput = document.getElementById('arrival');
            var timeInput = document.getElementById('flight-time');
            var typeSelect = document.getElementById('flight-type');

            var departure = departureInput.value.trim();
            var arrival = arrivalInput.value.trim();
            var time = timeInput.value;
            var type = typeSelect.value;

            if (!departure || !arrival) {
                alert('请输入出发和到达机场');
                return;
            }
            
            // 搜索出发机场
            var departureResults = searchAirport(departure);
            if (departureResults.length === 0) {
                alert('未找到出发机场，请检查输入或尝试使用IATA代码（如PEK、SHA等）');
                return;
            }
            
            // 搜索到达机场
            var arrivalResults = searchAirport(arrival);
            if (arrivalResults.length === 0) {
                alert('未找到到达机场，请检查输入或尝试使用IATA代码（如PEK、SHA等）');
                return;
            }
            
            var from = departureResults[0];
            var to = arrivalResults[0];
            
            // 检查是否为相同机场
            if (from.code === to.code) {
                alert('出发和到达机场不能相同');
                return;
            }
            
            console.log('添加航线:', from.code, '→', to.code, '类型:', type);
            
            // 保存航线信息
            flightInfo.push({ from, to, time, type });
            localStorage.setItem('flightInfo', JSON.stringify(flightInfo));
            
            // 绘制航线
            drawFlight(from, to, type, flightInfo.length - 1);
            updateFlightList();
            
            // 清空输入框
            departureInput.value = '';
            arrivalInput.value = '';
            timeInput.value = '';
            
            // 调整地图视图
            fitMapToFlights();
        }

        // 删除航线
        function removeFlight(index) {
            // 移除地图上的航线
            if (flightPaths[index] && window.travelMap) {
                window.travelMap.removeLayer(flightPaths[index].path);
                flightPaths[index].markers.forEach(marker => window.travelMap.removeLayer(marker));
            }
            
            // 从数组和存储中移除
            flightInfo.splice(index, 1);
            flightPaths.splice(index, 1);
            localStorage.setItem('flightInfo', JSON.stringify(flightInfo));
            
            // 重新绘制所有航线（更新颜色）
            clearFlightPaths();
            flightInfo.forEach((flight, i) => {
                drawFlight(flight.from, flight.to, flight.type, i);
            });
            
            updateFlightList();
        }

        // 清除所有航线
        function clearFlights() {
            clearFlightPaths();
            flightInfo = [];
            localStorage.removeItem('flightInfo');
            updateFlightList();
        }
        
        // 播放航线动画
        var currentFlightIndex = 0; // 当前播放的航线索引
        var isPlaying = false; // 新增：是否正在播放动画

        function toggleAnimation() {
            if (isPlaying) {
                stopAnimation();
                document.getElementById('toggleAnimationBtn').textContent = '播放航线动画';
                document.getElementById('toggleAnimationBtn').style.backgroundColor = '#FF6347';
                isPlaying = false;
            } else {
                playAnimation();
                document.getElementById('toggleAnimationBtn').textContent = '暂停航线动画';
                document.getElementById('toggleAnimationBtn').style.backgroundColor = '#FF8C00';
                isPlaying = true;
            }
        }

        function playAnimation() {
            // 停止现有动画
            stopAnimation();

            if (flightInfo.length === 0) {
                alert('没有航线可以播放');
                return;
            }

            // 按时间排序航线
            flightInfo.sort((a, b) => new Date('1970/01/01 ' + a.time) - new Date('1970/01/01 ' + b.time));

            // 从当前索引开始播放
            playNextFlightAnimation();
        }

        function playNextFlightAnimation() {
            if (currentFlightIndex >= flightInfo.length) {
                console.log('所有航线动画播放完毕');
                stopAnimation();
                currentFlightIndex = 0; // 重置索引以便下次播放
                return;
            }

            var flight = flightInfo[currentFlightIndex];
            console.log('播放航线动画:', flight.from.code, '→', flight.to.code, '时间:', flight.time);

            // 创建飞机图标
            var planeIcon = L.divIcon({
                className: 'animated-plane',
                html: '<div style="font-size: 30px; transform: rotate(45deg); filter: drop-shadow(0 0 5px white);">✈️</div>',
                iconSize: [30, 30]
            });

            // 获取航线路径点
            var pathPoints;
            if (flight.type === 'curved') {
                pathPoints = calculateCurvedPath(flight.from, flight.to);
            } else {
                pathPoints = [[flight.from.lat, flight.from.lng], [flight.to.lat, flight.to.lng]];
            }

            // 创建动画标记
            animationMarker = L.marker(pathPoints[0], { icon: planeIcon }).addTo(window.travelMap);

            // 调整地图视图以显示当前航线
            if (window.travelMap) {
                var bounds = L.latLngBounds([flight.from.lat, flight.from.lng], [flight.to.lat, flight.to.lng]);
                window.travelMap.fitBounds(bounds, { padding: [50, 50] });
            }

            // 动画参数
            var step = 0;
            var totalSteps = flight.type === 'curved' ? pathPoints.length : 100;
            var animationDuration = 3000; // 每条航线动画持续时间（毫秒）
            var intervalTime = animationDuration / totalSteps; // 计算每步的时间间隔

            // 开始动画
            animationInterval = setInterval(function() {
                if (step >= totalSteps) {
                    clearInterval(animationInterval);
                    window.travelMap.removeLayer(animationMarker);
                    animationMarker = null;
                    currentFlightIndex++;
                    playNextFlightAnimation(); // 播放下一条航线
                    return;
                }

                var position;
                if (flight.type === 'curved') {
                    // 弧线路径直接使用预计算的点
                    position = pathPoints[step];
                } else {
                    // 直线路径插值计算
                    var t = step / totalSteps;
                    var lat = flight.from.lat + (flight.to.lat - flight.from.lat) * t;
                    var lng = flight.from.lng + (flight.to.lng - flight.from.lng) * t;
                    position = [lat, lng];
                }

                // 更新飞机位置
                animationMarker.setLatLng(position);

                step++;
            }, intervalTime);
        }
        
        // 停止动画
        function stopAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            
            if (animationMarker && window.travelMap) {
                window.travelMap.removeLayer(animationMarker);
                animationMarker = null;
            }
            
            if (!isPlaying) return;
            document.getElementById('toggleAnimationBtn').textContent = '播放航线动画';
            document.getElementById('toggleAnimationBtn').style.backgroundColor = '#FF6347';
            isPlaying = false;
        }

        // 注意：页面加载时重新绘制轨迹和更新列表的逻辑已移至DOM加载完成事件中
        // 添加页面可见性变化监听，解决页面切换后地图可能不显示的问题
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && window.travelMap) {
                console.log('页面变为可见，刷新地图');
                window.travelMap.invalidateSize();
                if (flightPaths.length > 0) {
                    // 重新绘制所有航线
                    clearFlightPaths();
                    flightInfo.forEach((flight, i) => {
                        drawFlight(flight.from, flight.to, flight.type, i);
                    });
                }
            }
        });
        
        // 添加窗口大小变化监听，确保地图正确调整大小
        window.addEventListener('resize', function() {
            if (window.travelMap) {
                console.log('窗口大小变化，刷新地图大小');
                window.travelMap.invalidateSize();
            }
        });

        // 导出航线数据为JSON文件
        function exportFlightPaths() {
            if (flightInfo.length === 0) {
                alert('没有航线数据可以导出！');
                return;
            }

            const dataStr = JSON.stringify(flightInfo, null, 4); // 格式化JSON
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = 'flight_paths.json';

            let linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click(); // 模拟点击下载
            linkElement.remove(); // 移除创建的a标签
        }

        // 折叠侧栏函数
        function toggleSidebar() {
            var sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // 绑定导出按钮事件
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.getElementById('exportFlightsBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportFlightPaths);
            }

            // 自动补全逻辑
            function setupAutocomplete(inputId, suggestionsId) {
                const input = document.getElementById(inputId);
                const suggestionsContainer = document.getElementById(suggestionsId);

                input.addEventListener('input', function() {
                    const query = this.value;
                    suggestionsContainer.innerHTML = '';
                    if (query.length < 2) {
                        return;
                    }

                    const results = searchAirport(query);
                    results.forEach(airport => {
                        const item = document.createElement('div');
                        item.classList.add('suggestion-item');
                        item.textContent = `${airport.code} - ${airport.name}`;
                        item.addEventListener('click', function() {
                            input.value = airport.code;
                            suggestionsContainer.innerHTML = '';
                        });
                        suggestionsContainer.appendChild(item);
                    });
                });

                // 点击其他地方或输入框失去焦点时隐藏建议
                document.addEventListener('click', function(event) {
                    if (!input.contains(event.target) && !suggestionsContainer.contains(event.target)) {
                        suggestionsContainer.innerHTML = '';
                    }
                });

                input.addEventListener('blur', function() {
                    // 延迟清除，以便点击建议项的click事件能够触发
                    setTimeout(() => {
                        suggestionsContainer.innerHTML = '';
                    }, 100);
                });
            }

            setupAutocomplete('departure', 'departure-suggestions');
            setupAutocomplete('arrival', 'arrival-suggestions');
        });
    </script>
</body>
</html>